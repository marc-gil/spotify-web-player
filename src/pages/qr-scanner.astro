---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Pachehitster QR Scanner">
  <main class="scan-page">
    <section>
      <video
        id="qr-video"
        class="scanner-video"
        autoplay="true"
        autoplay
        playsinline></video>
      <div class="scanner-overlay"></div>
    </section>
  </main>
</Layout>

<style>
  section {
    position: relative;
    background: #000;
  }

  video {
    width: 100%;
    height: 100%;
  }

  .scanner-overlay {
    pointer-events: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 300px;
    height: 300px;
    border: 4px solid rgba(255, 255, 255, 0.8);
    box-shadow:
      0 0 0 100vmax rgba(0, 0, 0, 0.7),
      inset 0 0 1px rgba(255, 255, 255, 0.3);
  }
</style>

<script>
  import jsQR from "jsqr";
  const videoElem = document.getElementById("qr-video") as HTMLVideoElement;
  let canvas: OffscreenCanvas | null = null;
  let ctx: OffscreenCanvasRenderingContext2D | null = null;

  document.addEventListener("DOMContentLoaded", async () => {
    const constraints = await getBackCameraConstraints();

    navigator.mediaDevices
      .getUserMedia(constraints)
      .then((stream) => {
        videoElem.srcObject = stream;
        videoElem.play().then(() => {
          canvas = new OffscreenCanvas(
            videoElem.videoWidth,
            videoElem.videoHeight,
          );
          ctx = canvas.getContext("2d", {
            willReadFrequently: true,
          })!;
          scanQRCode();
        });
      })
      .catch((err) => {
        console.error(`An error occurred trying to open the video: ${err}`);
      });
  });

  async function getBackCameraConstraints(): Promise<MediaStreamConstraints> {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(
      (device) => device.kind === "videoinput",
    );

    console.log("Available cameras:", videoDevices);

    let backCamera = videoDevices.find(
      (device) =>
        device.label.toLowerCase().includes("back") ||
        device.label.toLowerCase().includes("environment") ||
        device.label.toLowerCase().includes("rear"),
    );

    return backCamera
      ? {
          video: {
            deviceId: { exact: backCamera.deviceId },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 } 
          },
        }
      : {
          video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 } 
          },
        };
  }

  async function scanQRCode() {
    const imageData = await getImageData(videoElem);

    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "attemptBoth",
    });

    if (code && code.data) {
      const qrData = code.data;
      console.log("QR Code detected:", qrData);
      if (qrData.includes("/track/")) {
        window.location.href = qrData;
      }
      return;
    }

    requestAnimationFrame(scanQRCode);
  }

  function getImageData(videoElem: HTMLVideoElement): ImageData {
    ctx!.drawImage(videoElem, 0, 0);
    return ctx!.getImageData(0, 0, canvas!.width, canvas!.height);
  }
</script>
